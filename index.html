<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Harita Projesi</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
        }
        #content {
            display: flex;
            width: 100%;
            height: 80vh;
        }
        #filters {
            width: 100%;
            height: 20vh;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: #f0f0f0;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #map {
            flex: 1;
        }
        #dynamic-data, #statistics {
            width: 20%;
            height: 100%;
            overflow-y: auto;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: #fff;
        }
        #dynamic-data {
            order: 1;
        }
        #map-container {
            width: 60%;
            height: 100%;
            order: 2;
            display: flex;
        }
        #statistics {
            order: 3;
            display: flex;
            flex-wrap: wrap;
        }
        .statistics-table {
            width: 45%;
            height: 45%;
            overflow-y: auto;
            padding: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: #fff;
            box-sizing: border-box;
            margin: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 4px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div id="filters">
        <select id="os-filter">
            <option value="all">Tüm İşletim Sistemleri</option>
        </select>
        <select id="client-filter">
            <option value="all">Tüm İstemci Türleri</option>
        </select>
        <select id="country-filter">
            <option value="all">Tüm Ülkeler</option>
        </select>
        <select id="relationship-filter">
            <option value="all">Tüm İlişkiler</option>
        </select>
        <button id="apply-filters">Filtreleri Uygula</button>
    </div>
    <div id="content">
        <div id="dynamic-data">
            <h3>Dinamik Veriler</h3>
        </div>
        <div id="map-container">
            <div id="map"></div>
        </div>
        <div id="statistics">
            <div class="statistics-table" id="os-statistics">
                <h4>İşletim Sistemleri</h4>
                <table>
                    <thead>
                        <tr><th>OS</th><th>Yüzdelik</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="statistics-table" id="client-statistics">
                <h4>İstemci Türleri</h4>
                <table>
                    <thead>
                        <tr><th>İstemci</th><th>Yüzdelik</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="statistics-table" id="isp-statistics">
                <h4>ISP</h4>
                <table>
                    <thead>
                        <tr><th>ISP</th><th>Yüzdelik</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="statistics-table" id="country-statistics">
                <h4>Ülkeler</h4>
                <table>
                    <thead>
                        <tr><th>Ülke</th><th>Yüzdelik</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="node-details">
        <h3>Node Detayları</h3>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/d3/dist/d3.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var map = L.map('map').setView([0, 0], 2);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            var markers = L.markerClusterGroup();
            var allMarkers = [];

            function fetchAndPopulateData() {
                fetch('https://api.eth-node-map.xyz/get-nodes')
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(node => {
                            var marker = L.marker([node.Latitude, node.Longitude], {
                                os: node.OS,
                                client: node.Client,
                                country: node.Country,
                                nodeId: node.NodeId,
                                relationships: node.Relationships || []
                            }).bindPopup(`<b>${node.Client}</b><br>${node.Country}<br>${node.Host}<br>${node.ISP}<br>${node.OS}<br>${node.Port}`);
                            marker.on('click', function() {
                                fetchNodeDetails(node.NodeId);
                            });
                            allMarkers.push(marker);
                            markers.addLayer(marker);
                        });
                        map.addLayer(markers);
                    });
            }

            function fetchFilters() {
                fetch('https://api.eth-node-map.xyz/get-os-types')
                    .then(response => response.json())
                    .then(data => {
                        const osFilter = document.getElementById('os-filter');
                        data.forEach(osType => {
                            let option = document.createElement('option');
                            option.value = osType;
                            option.text = osType;
                            osFilter.add(option);
                        });
                    });

                fetch('https://api.eth-node-map.xyz/get-client-types')
                    .then(response => response.json())
                    .then(data => {
                        const clientFilter = document.getElementById('client-filter');
                        data.forEach(clientType => {
                            let option = document.createElement('option');
                            option.value = clientType;
                            option.text = clientType;
                            clientFilter.add(option);
                        });
                    });

                fetch('https://api.eth-node-map.xyz/get-countries')
                    .then(response => response.json())
                    .then(data => {
                        const countryFilter = document.getElementById('country-filter');
                        data.forEach(country => {
                            let option = document.createElement('option');
                            option.value = country;
                            option.text = country;
                            countryFilter.add(option);
                        });
                    });

                fetch('https://api.eth-node-map.xyz/get-relationship-types/clients')
                    .then(response => response.json())
                    .then(data => {
                        const relationshipFilter = document.getElementById('relationship-filter');
                        data.forEach(relationship => {
                            let option = document.createElement('option');
                            option.value = relationship;
                            option.text = relationship;
                            relationshipFilter.add(option);
                        });
                    });

                fetch('https://api.eth-node-map.xyz/get-relationship-types/countries')
                    .then(response => response.json())
                    .then(data => {
                        const relationshipFilter = document.getElementById('relationship-filter');
                        data.forEach(relationship => {
                            let option = document.createElement('option');
                            option.value = relationship;
                            option.text = relationship;
                            relationshipFilter.add(option);
                        });
                    });

                fetch('https://api.eth-node-map.xyz/get-relationship-types/os-types')
                    .then(response => response.json())
                    .then(data => {
                        const relationshipFilter = document.getElementById('relationship-filter');
                        data.forEach(relationship => {
                            let option = document.createElement('option');
                            option.value = relationship;
                            option.text = relationship;
                            relationshipFilter.add(option);
                        });
                    });

                fetch('https://api.eth-node-map.xyz/get-relationship-types/isps')
                    .then(response => response.json())
                    .then(data => {
                        const relationshipFilter = document.getElementById('relationship-filter');
                        data.forEach(relationship => {
                            let option = document.createElement('option');
                            option.value = relationship;
                            option.text = relationship;
                            relationshipFilter.add(option);
                        });
                    });
            }

            function fetchDynamicData() {
                fetch('https://api.eth-node-map.xyz/get-node-count')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('dynamic-data').innerHTML = `<h3>Dinamik Veriler</h3><p>Toplam Node Sayısı: ${data.NumberOfNodes}</p>`;
                    });
            }

            function fetchStatistics(endpoint, tableId) {
                fetch(endpoint)
                    .then(response => response.json())
                    .then(data => {
                        const tableBody = document.querySelector(`#${tableId} tbody`);
                        tableBody.innerHTML = '';
                        Object.keys(data).forEach(key => {
                            const row = document.createElement('tr');
                            const keyCell = document.createElement('td');
                            const valueCell = document.createElement('td');
                            keyCell.textContent = key.split('_')[1];
                            valueCell.textContent = `%${data[key].toFixed(2)}`;
                            row.appendChild(keyCell);
                            row.appendChild(valueCell);
                            tableBody.appendChild(row);
                        });
                    });
            }

            function fetchNodeDetails(nodeId) {
                fetch(`https://api.eth-node-map.xyz/get-node-details/${nodeId}`)
                    .then(response => response.json())
                    .then(data => {
                        const nodeDetailsDiv = document.getElementById('node-details');
                        nodeDetailsDiv.innerHTML = `
                            <h3>Node Detayları</h3>
                            <p><b>Client:</b> ${data.Client}</p>
                            <p><b>Country:</b> ${data.Country}</p>
                            <p><b>Host:</b> ${data.Host}</p>
                            <p><b>ISP:</b> ${data.ISP}</p>
                            <p><b>Latitude:</b> ${data.Latitude}</p>
                            <p><b>Longitude:</b> ${data.Longitude}</p>
                            <p><b>NodeId:</b> ${data.NodeId}</p>
                            <p><b>OS:</b> ${data.OS}</p>
                            <p><b>Port:</b> ${data.Port}</p>
                            <p><b>Status:</b> ${data.Status}</p>
                        `;
                    });
            }

            function applyFilters() {
                var osFilterValue = document.getElementById('os-filter').value;
                var clientFilterValue = document.getElementById('client-filter').value;
                var countryFilterValue = document.getElementById('country-filter').value;
                var relationshipFilterValue = document.getElementById('relationship-filter').value;

                markers.clearLayers();

                allMarkers.forEach(marker => {
                    var markerOS = marker.options.os;
                    var markerClient = marker.options.client;
                    var markerCountry = marker.options.country;
                    var markerRelationships = marker.options.relationships;

                    var relationshipMatch = markerRelationships.includes(relationshipFilterValue) || relationshipFilterValue === 'all';

                    if ((osFilterValue === 'all' || markerOS === osFilterValue) &&
                        (clientFilterValue === 'all' || markerClient === clientFilterValue) &&
                        (countryFilterValue === 'all' || markerCountry === countryFilterValue) &&
                        relationshipMatch) {
                        markers.addLayer(marker);
                    }
                });

                map.addLayer(markers);
            }

            fetchAndPopulateData();
            fetchFilters();
            fetchDynamicData();

            fetchStatistics('https://api.eth-node-map.xyz/get-relationship-percentage/OS_', 'os-statistics');
            fetchStatistics('https://api.eth-node-map.xyz/get-relationship-percentage/CLIENT_', 'client-statistics');
            fetchStatistics('https://api.eth-node-map.xyz/get-relationship-percentage/ISP_', 'isp-statistics');
            fetchStatistics('https://api.eth-node-map.xyz/get-relationship-percentage/COUNTRY_', 'country-statistics');

            document.getElementById('apply-filters').addEventListener('click', applyFilters);

            setInterval(fetchDynamicData, 30000);
            setInterval(() => fetchStatistics('https://api.eth-node-map.xyz/get-relationship-percentage/OS_', 'os-statistics'), 30000);
            setInterval(() => fetchStatistics('https://api.eth-node-map.xyz/get-relationship-percentage/CLIENT_', 'client-statistics'), 30000);
            setInterval(() => fetchStatistics('https://api.eth-node-map.xyz/get-relationship-percentage/ISP_', 'isp-statistics'), 30000);
            setInterval(() => fetchStatistics('https://api.eth-node-map.xyz/get-relationship-percentage/COUNTRY_', 'country-statistics'), 30000);
        });
    </script>
</body>
</html>
